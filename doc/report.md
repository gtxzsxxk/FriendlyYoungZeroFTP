---
author: 软件21 赵涵远 2022010818
title: 基于 POLL 机制与零拷贝的高性能 FTP 服务器实现
---

# Introduction

在高并发网络编程中，I/O多路复用技术是提升服务器性能的关键。POLL机制是一种广泛应用的I/O多路复用方法，它通过轮询一组文件描述符，检测其状态变化，实现对多个网络连接的高效管理。相比于为每个连接创建独立线程或进程的方法，如果同时有1000个连接，那么就需要新开1000个线程/进程，这会对服务器资源造成极大的浪费。使用POLL可以显著减少系统在内存、调度上的资源消耗，提升并发处理能力。

本作业中，我们在主线程中利用POLL机制处理控制通道的通信，同时在另外两个线程中分别处理PORT和PASV模式下的数据通道的POLL操作。这样的设计避免了为每个连接创建额外的线程或进程，充分发挥了POLL机制的优势，节约了CPU资源，提高了服务器的整体性能。

零拷贝技术是优化数据传输效率的重要手段。传统的数据传输需要从网络接收一点数据，又往文件系统中写入一些数据。这会导致计算机在用户态和内核态之间多次数据拷贝，增加了CPU的负载。通过使用`sendfile`系统调用，可以在内核态直接将文件数据从文件系统拷贝到网络缓冲区，避免了数据在用户态和内核态之间的拷贝过程。这种方法不仅提高了数据传输效率，还降低了系统资源的占用。

我的实现使用`sendfile`进行文件传输，使得服务器能够高效地处理大文件的传输任务。由于POLL机制的使用与并发编程模型，服务器支持同时连接多个客户端，能够快速列出包含5000个文件的目录，多客户端还能同时下载大文件，传输速率与业界知名的vsftpd服务器相当，并支持断点续传功能。具体比较如图1、图2所示。（速率只有`1.3 GiBs`，远远没有达到本地回环可以有的带宽，这是因为发送端的 WSL 运行在磁盘内，而不是 SSD，这造成了性能瓶颈）

尽管EPOLL在Linux系统上具有更高的性能，但为了实现更好的跨平台兼容性，我们选择了POLL机制。POLL在Linux和macOS等操作系统上都有良好的支持，使用POLL可以使我们的FTP服务器在不同的平台上运行，而无需针对特定平台进行额外的适配。

![vsftpd的传输速率](vsftpd_speed.png){height=50%}

![我实现的FTP服务器的传输速率](fyz_speed.png){height=50%}

# Implementation

我的实现使用`sendfile`进行文件传输，使得服务器能够高效地处理大文件的传输任务。由于POLL机制的使用与并发编程模型，服务器支持同时连接多个客户端，能够快速列出包含5000个文件的目录，多客户端还能同时下载大文件，传输速率与业界知名的vsftpd服务器相当，并支持断点续传功能。具体比较如图1、图2所示。（速率只有`1.3 GiBs`，远远没有达到本地回环可以有的带宽，这是因为发送端的 WSL 运行在磁盘内，而不是 SSD，这造成了性能瓶颈）

尽管EPOLL在Linux系统上具有更高的性能，但为了实现更好的跨平台兼容性，我们选择了POLL机制。POLL在Linux和macOS等操作系统上都有良好的支持，使用POLL可以使我们的FTP服务器在不同的平台上运行，而无需针对特定平台进行额外的适配。
